<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer (WebM)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><span class="title-text">./view_webm_live.sh</span></div>
        <div class="card-body">
            <h2 id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</h2>
            <video id="remoteVideo" autoplay playsinline style="width: 100%; background-color: #000; border-radius: 8px; min-height: 200px;"></video>
        </div>
    </div>
</div>
<script>
    const statusEl = document.getElementById('status');
    const remoteVideo = document.getElementById('remoteVideo');
    const SERVER_URL = 'wss://9d2488b5-3986-4269-bfdd-d01f421e0f4c-00-asck2nhxkvc6.pike.replit.dev/';
    
    function startPlayer() {
        const ws = new WebSocket(SERVER_URL, 'viewer');
        let mediaSource = new MediaSource();
        remoteVideo.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener('sourceopen', () => {
            statusEl.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...';
            try {
                const sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs=vp8');
                
                ws.onmessage = async event => {
                    if (typeof event.data === 'string') {
                        if (event.data === 'stream-started' || event.data === 'stream-ended') {
                            statusEl.textContent = event.data === 'stream-started' ? '‚ñ∂Ô∏è –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–∞—á–∞–ª–∞—Å—å!' : '‚èπÔ∏è –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.';
                        }
                        return;
                    }
                    
                    if (!sourceBuffer.updating) {
                        sourceBuffer.appendBuffer(await event.data.arrayBuffer());
                    }
                };
            } catch (e) {
                statusEl.textContent = '‚õîÔ∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è SourceBuffer. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.';
                console.error(e);
            }
        });

        ws.onclose = () => {
            statusEl.textContent = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ.';
        };
    }
    
    startPlayer();
</script>
</body>
</html>
