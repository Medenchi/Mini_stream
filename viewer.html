<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer (WebRTC Auto)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><span class="title-text">./view_webrtc_live.sh</span></div>
        <div class="card-body">
            <h2 id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</h2>
            <video id="remoteVideo" autoplay playsinline style="width: 100%; background-color: #000; border-radius: 8px; min-height: 200px;"></video>
        </div>
    </div>
</div>
<script>
    const statusEl = document.getElementById('status');
    const remoteVideo = document.getElementById('remoteVideo');
    const SERVER_URL = 'wss://9d2488b5-3986-4269-bfdd-d01f421e0f4c-00-asck2nhxkvc6.pike.replit.dev/';
    let peerConnection;
    const config = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun.services.mozilla.com' },
        {
          urls: 'turn:openrelay.metered.ca:80',
          username: 'openrelayproject',
          credential: 'openrelayproject'
        }
      ]
    };
    
    function connect() {
        const ws = new WebSocket(SERVER_URL, 'viewer');

        ws.onopen = () => { statusEl.textContent = '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...'; };

        ws.onmessage = async event => {
            const message = JSON.parse(event.data);
            
            if (message.type === 'offer') {
                statusEl.textContent = 'üîå –ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...';
                if (peerConnection) peerConnection.close();
                peerConnection = new RTCPeerConnection(config);
                
                peerConnection.ontrack = event => {
                    remoteVideo.srcObject = event.streams[0];
                    statusEl.style.display = 'none';
                };

                peerConnection.onicecandidate = e => {
                    if (e.candidate) { ws.send(JSON.stringify({ type: 'ice-candidate', candidate: e.candidate })); }
                };
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                ws.send(JSON.stringify(answer));

            } else if (message.type === 'ice-candidate') {
                if (peerConnection) { await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate)); }
            }
        };
        
        ws.onclose = () => {
            statusEl.textContent = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5—Å...';
            if (peerConnection) { peerConnection.close(); }
            remoteVideo.srcObject = null;
            setTimeout(connect, 5000);
        };
    }
    connect();
</script>
</body>
</html>
