<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer (WebM)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><span class="dot red"></span><span class="title-text">./webm_broadcast.sh</span></div>
        <div class="card-body">
            <h2 id="status">–ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...</h2>
            <p>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è WebM –ø–æ–≤–µ—Ä—Ö WebSocket.</p>
            <video id="localVideo" autoplay muted playsinline style="width:100%; border-radius: 8px; background: #000;"></video>
        </div>
    </div>
</div>
<script>
    const statusEl = document.getElementById('status');
    const localVideo = document.getElementById('localVideo');
    const SERVER_URL = 'wss://9d2488b5-3986-4269-bfdd-d01f421e0f4c-00-asck2nhxkvc6.pike.replit.dev/';
    
    async function startStream() {
        statusEl.textContent = '–í–∫–ª—é—á–∞—é –∫–∞–º–µ—Ä—É...';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 640, height: 480 },
                audio: false
            });
            localVideo.srcObject = stream;
            
            const ws = new WebSocket(SERVER_URL, 'streamer');
            ws.onopen = () => {
                statusEl.textContent = 'üü¢ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞!';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ MediaRecorder
                if (typeof MediaRecorder === 'undefined') {
                    statusEl.textContent = '‚õîÔ∏è MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
                    return;
                }
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                        ws.send(event.data);
                    }
                };
                
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                mediaRecorder.start(2000);
            };

            ws.onclose = () => { statusEl.textContent = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ.'; };
            ws.onerror = () => { statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.'; };

        } catch (err) {
            statusEl.textContent = '‚õîÔ∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ.';
            console.error(err);
        }
    }
    
    startStream();
</script>
</body>
</html>
