<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Control Panel</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div class="card">
        <div class="card-header">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
            <span class="title-text">./stream_control.sh</span>
        </div>
        <div class="card-body">

            <!-- БЛОК 1: ЗАПУСК КАМЕРЫ И СОЗДАНИЕ ПРЕДЛОЖЕНИЯ -->
            <div id="step1" class="block">
                <h2 class="block-title">>_ Initialize Stream</h2>
                <p class="block-description">Press the button to start the camera and generate a connection offer for the viewer.</p>
                <button id="startButton" class="download-button">Start Camera & Generate Offer</button>
            </div>
            
            <video id="localVideo" class="block-image hidden" autoplay muted playsinline></video>

            <!-- БЛОК 2: ОТПРАВКА ПРЕДЛОЖЕНИЯ И ПОЛУЧЕНИЕ ОТВЕТА -->
            <div id="step2" class="block hidden">
                <h2 class="block-title">>_ Send Offer / Get Answer</h2>
                <p class="block-description"><b>1. Copy this OFFER</b> and send it to the viewer.</p>
                <textarea id="offerSdp" readonly></textarea>
                <p class="block-description" style="margin-top: 20px;"><b>2. Paste the viewer's ANSWER</b> below and connect.</p>
                <textarea id="answerSdp" placeholder="Paste viewer's answer here..."></textarea>
                <button id="setAnswerButton" class="download-button">Set Answer & Connect</button>
            </div>

        </div>
    </div>
</div>

<script>
    let localStream, peerConnection;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    const startButton = document.getElementById('startButton');
    const setAnswerButton = document.getElementById('setAnswerButton');
    const localVideo = document.getElementById('localVideo');
    const offerSdpTextarea = document.getElementById('offerSdp');
    const answerSdpTextarea = document.getElementById('answerSdp');

    startButton.addEventListener('click', async () => {
        startButton.disabled = true;
        startButton.textContent = 'Starting Camera...';

        try {
            // Запускаем камеру
            localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            localVideo.srcObject = localStream;
            localVideo.classList.remove('hidden');
            
            startButton.textContent = 'Generating Offer...';

            // Создаем PeerConnection
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            // Ждем генерации всех ICE-кандидатов
            peerConnection.onicecandidate = e => {
                if (e.candidate === null) {
                    // Как только все готово, показываем второй шаг
                    offerSdpTextarea.value = JSON.stringify(peerConnection.localDescription);
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                }
            };
            
            // Создаем Offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

        } catch (error) {
            console.error('CAMERA_ERROR:', error);
            alert('ERROR: Camera access denied. Check browser permissions and reload the page.');
            startButton.disabled = false;
            startButton.textContent = 'Start Camera & Generate Offer';
        }
    });

    setAnswerButton.addEventListener('click', async () => {
        if (!answerSdpTextarea.value) {
            alert('ERROR: Viewer answer cannot be empty.');
            return;
        }
        try {
            const answer = JSON.parse(answerSdpTextarea.value);
            await peerConnection.setRemoteDescription(answer);
            setAnswerButton.disabled = true;
            setAnswerButton.textContent = 'Connection Established';
            setAnswerButton.style.backgroundColor = '#27c93f';
        } catch (error) {
            console.error('ANSWER_ERROR:', error);
            alert('ERROR: Invalid answer format.');
        }
    });
</script>

</body>
</html>
