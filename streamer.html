<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer (Slideshow)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><span class="dot red"></span><span class="title-text">./slideshow_broadcast.sh</span></div>
        <div class="card-body">
            <h2 id="status">–ó–∞–ø—É—Å–∫ —Å–ª–∞–π–¥-—à–æ—É...</h2>
            <p>–ù–∞–¥–µ–∂–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (~17fps).</p>
            <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
    </div>
</div>
<script>
    const statusEl = document.getElementById('status');
    const video = document.getElementById('localVideo');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const SERVER_URL = 'wss://9d2488b5-3986-4269-bfdd-d01f421e0f4c-00-asck2nhxkvc6.pike.replit.dev/';
    
    const FPS = 17;
    const FRAME_INTERVAL = 1000 / FPS;
    let lastFrameTime = 0;

    async function start() {
        statusEl.textContent = '–í–∫–ª—é—á–∞—é –∫–∞–º–µ—Ä—É...';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 480, height: 360 }, // –ú–µ–Ω—å—à–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                audio: false
            });
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                connectAndStream();
            };

        } catch (err) {
            statusEl.textContent = '‚õîÔ∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ.';
        }
    }

    function connectAndStream() {
        const ws = new WebSocket(SERVER_URL, 'streamer');

        ws.onopen = () => {
            statusEl.textContent = 'üü¢ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞!';
            requestAnimationFrame(captureFrame);
        };

        function captureFrame(now) {
            if (ws.readyState !== WebSocket.OPEN) return;

            requestAnimationFrame(captureFrame); // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤
            
            if (now - lastFrameTime < FRAME_INTERVAL) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
            }
            lastFrameTime = now;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Blob (–¥–≤–æ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) - —ç—Ç–æ –±—ã—Å—Ç—Ä–æ!
            canvas.toBlob(blob => {
                if (blob && ws.readyState === WebSocket.OPEN) {
                    ws.send(blob);
                }
            }, 'image/jpeg', 0.5); // –ö–∞—á–µ—Å—Ç–≤–æ 0.5 –¥–ª—è –±–∞–ª–∞–Ω—Å–∞
        }

        ws.onclose = () => {
            statusEl.textContent = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ.';
        };
    }
    
    start();
</script>
</body>
</html>
