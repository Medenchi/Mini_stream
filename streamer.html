<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Control Panel (AUTO)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
            <span class="title-text">./start_autostream.sh</span>
        </div>
        <div class="card-body">
            <div class="block">
                <h2 id="statusTitle" class="block-title">>_ Waiting to Start</h2>
                <p id="statusDesc" class="block-description">Starting stream automatically. Please grant camera access when prompted.</p>
                <div id="loader" class="hidden" style="text-align:center; padding: 20px; font-size: 1.5em;">ðŸ“¡</div>
            </div>
            <video id="localVideo" class="block-image" autoplay muted playsinline></video>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        databaseURL: "https://my-street-cam-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const streamRoomRef = database.ref('stream/my-street');

    const localVideo = document.getElementById('localVideo');
    const statusTitle = document.getElementById('statusTitle');
    const statusDesc = document.getElementById('statusDesc');
    const loader = document.getElementById('loader');

    let peerConnection;
    // --- Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð• Ð—Ð”Ð•Ð¡Ð¬ ---
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ TURN-ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‹ÑˆÐµÐ½Ð¸Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
            }
        ]
    };
    // --- ÐšÐžÐÐ•Ð¦ Ð˜Ð—ÐœÐ•ÐÐ•ÐÐ˜Ð¯ ---

    async function startStream() {
        try {
            statusTitle.textContent = '>_ Initializing Camera';
            loader.classList.remove('hidden');
            await streamRoomRef.set(null);
            const localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            localVideo.srcObject = localStream;
            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            peerConnection.onicecandidate = e => {
                if (e.candidate === null) {
                    const offer = JSON.stringify(peerConnection.localDescription);
                    streamRoomRef.child('offer').set(offer);
                    statusTitle.textContent = '>_ Waiting for Viewer';
                    statusDesc.textContent = 'Offer sent. Open the viewer page on another device.';
                }
            };
            streamRoomRef.child('answer').on('value', async snapshot => {
                if (snapshot.exists() && !peerConnection.currentRemoteDescription) {
                    await peerConnection.setRemoteDescription(JSON.parse(snapshot.val()));
                    statusTitle.textContent = '>_ Connection Established!';
                    statusDesc.textContent = 'Stream is now live for the viewer.';
                    loader.classList.add('hidden');
                }
            });
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
        } catch (error) {
            console.error("Stream Start Error:", error);
            statusTitle.textContent = '>_ ERROR';
            statusDesc.textContent = 'Could not start stream. Check camera permissions and reload.';
        }
    }
    window.addEventListener('load', startStream);
</script>
</body>
</html>
