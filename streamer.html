<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <div class="card-header"><span class="dot red"></span><span class="title-text">./broadcast.sh</span></div>
        <div class="card-body">
            <h2 id="status">–ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...</h2>
            <video id="localVideo" autoplay muted playsinline style="display: none;"></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
    </div>
</div>
<script>
    const statusEl = document.getElementById('status');
    const video = document.getElementById('localVideo');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    const SERVER_URL = 'wss://9d2488b5-3986-4269-bfdd-d01f421e0f4c-00-asck2nhxkvc6.pike.replit.dev/';
    
    async function start() {
        statusEl.textContent = '–ó–∞–ø—Ä–æ—Å –∫ –∫–∞–º–µ—Ä–µ...';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: 320, height: 240 },
                audio: false
            });
            video.srcObject = stream;
            
            await new Promise(resolve => { video.onloadedmetadata = resolve; });

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            connectAndStream();
        } catch (err) {
            statusEl.textContent = `–û–®–ò–ë–ö–ê –ö–ê–ú–ï–†–´: ${err.name}`;
        }
    }

    function connectAndStream() {
        const ws = new WebSocket(SERVER_URL, 'streamer');

        ws.onopen = () => {
            statusEl.textContent = 'üü¢ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞';
            let isSending = false; // –§–ª–∞–≥, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –∫–∞–¥—Ä–∞, –ø–æ–∫–∞ —Å—Ç–∞—Ä—ã–π –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setInterval –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π —á–∞—Å—Ç–æ—Ç—ã –∫–∞–¥—Ä–æ–≤
            setInterval(() => {
                if (ws.readyState !== WebSocket.OPEN || isSending) return;
                
                isSending = true;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => {
                    if (blob) {
                        ws.send(blob);
                    }
                    isSending = false;
                }, 'image/jpeg', 0.4); // –ö–∞—á–µ—Å—Ç–≤–æ 0.4 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
            }, 100); // ~10 FPS
        };

        ws.onclose = () => { statusEl.textContent = 'üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ.'; };
        ws.onerror = () => { statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.'; };
    }
    
    start();
</script>
</body>
</html>
